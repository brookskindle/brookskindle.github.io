
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://brookskindle.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://brookskindle.github.io/theme/pygments/dracula.min.css">
  <link rel="stylesheet" type="text/css" href="https://brookskindle.github.io/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://brookskindle.github.io/styles/styles.css" rel="stylesheet">





    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#282a36">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#282a36">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#282a36">

<meta name="author" content="Brooks Kindle" />
<meta name="description" content="For loops are the de facto default looping mechanism for python and is a concept that almost all programmers are familiar with. However, if you&#39;ve been around the python block a few times you&#39;ve probably seen (and maybe dabbled in) list comprehensions from time to time. The decision to use …" />
<meta name="keywords" content="python">

<meta property="og:site_name" content="Brooks Kindle"/>
<meta property="og:title" content="For loop and list comprehension performance"/>
<meta property="og:description" content="For loops are the de facto default looping mechanism for python and is a concept that almost all programmers are familiar with. However, if you&#39;ve been around the python block a few times you&#39;ve probably seen (and maybe dabbled in) list comprehensions from time to time. The decision to use …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://brookskindle.github.io/for-loop-and-list-comprehension-performance.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-04-27 21:00:00-07:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://brookskindle.github.io/author/brooks-kindle.html">
<meta property="article:section" content="programming"/>
<meta property="article:tag" content="python"/>
<meta property="og:image" content="/images/profile.jpg">

  <title>Brooks Kindle &ndash; For loop and list comprehension performance</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://brookskindle.github.io">
        <img src="/images/profile.jpg" alt="Brooks Kindle" title="Brooks Kindle">
      </a>
      <h1><a href="https://brookskindle.github.io">Brooks Kindle</a></h1>

<p>software engineer</p>
      <nav>
        <ul class="list">
          <li><a href="https://brookskindle.github.io/pages/about.html#about">About</a></li>
          <li><a href="https://brookskindle.github.io/pages/contact.html#contact">Contact</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/brookskindle" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/brookskindle/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://brookskindle.github.io">    Home
</a>

      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="for-loop-and-list-comprehension-performance">For loop and list comprehension performance</h1>
    <p>
          Posted on Fri 27 April 2018 in <a href="https://brookskindle.github.io/category/programming.html">programming</a>


    </p>
  </header>


  <div>
    <p>For loops are the de facto default looping mechanism for python and is a
concept that almost all programmers are familiar with. However, if you've been
around the python block a few times you've probably seen (and maybe dabbled in)
list comprehensions from time to time.</p>
<p>The decision to use one or the other should be a case-by-case basis. In my own
programming, I tend to use a list comprehension when building a result (list)
from another result, and a for loop for anything else. Because of my curious
nature, however, I began to wonder what the difference was, in terms of speed,
between the two approaches.</p>
<h1>Setting the stage</h1>
<p>I'm going to use the following trivial snippets of code when running the
comparisons:</p>
<p>for loop</p>
<div class="highlight"><pre><span></span><span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>


<p>list comprehension</p>
<div class="highlight"><pre><span></span><span class="n">mylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</pre></div>


<p>For varying values of <code>n</code>.</p>
<h1>timeit</h1>
<p>The easiest way to measure the runtime of code snippets is by using the
<a href="https://docs.python.org/3/library/timeit.html">timeit</a> module. I'll be using
ipython's built-in magic command for this.</p>
<p>To create a list of one-hundred thousand elements, it takes ~15 milliseconds
in a for loop</p>
<div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%%</span><span class="n">timeit</span>
   <span class="o">...</span><span class="p">:</span> <span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>
<span class="mf">14.9</span> <span class="n">ms</span> <span class="err">±</span> <span class="mi">206</span> <span class="err">µ</span><span class="n">s</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">100</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</pre></div>


<p>but only ~6 milliseconds to do the same thing with a list comprehension.</p>
<div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%%</span><span class="n">timeit</span>
   <span class="o">...</span><span class="p">:</span> <span class="n">mylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">)]</span>
   <span class="o">...</span><span class="p">:</span>
<span class="mf">6.09</span> <span class="n">ms</span> <span class="err">±</span> <span class="mf">53.8</span> <span class="err">µ</span><span class="n">s</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">100</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</pre></div>


<p>In this example, the list comprehension is over <strong>2.4x</strong> faster than the for
loop equivalent.</p>
<hr>
<p>If I instead iterate over one-thousand elements, the results are similar.</p>
<div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="o">%%</span><span class="n">timeit</span>
    <span class="o">...</span><span class="p">:</span> <span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="o">...</span><span class="p">:</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="o">...</span><span class="p">:</span>     <span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="o">...</span><span class="p">:</span>
<span class="mi">123</span> <span class="err">µ</span><span class="n">s</span> <span class="err">±</span> <span class="mi">568</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="o">%%</span><span class="n">timeit</span>
    <span class="o">...</span><span class="p">:</span> <span class="n">mylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
    <span class="o">...</span><span class="p">:</span>
<span class="mf">53.5</span> <span class="err">µ</span><span class="n">s</span> <span class="err">±</span> <span class="mi">709</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</pre></div>


<p>A <strong>2.3x</strong> speed improvement when using a list comprehension.</p>
<p>For two pieces of code that produce the same result, it seems surprising that
there is such a performance difference. There must be something going on under
the hood that makes list comprehensions so much more performant.</p>
<h1>dis</h1>
<p>Python has a really cool built-in module named
<a href="https://docs.python.org/3/library/dis.html">dis</a> (short for disassemble). We
can use it to disassemble pieces of code into their opcode equivalent to see
what each line of code does.</p>
<p>Running this code</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dis</span>

<span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">mylist = []</span>
<span class="s2">for i in range(1000):</span>
<span class="s2">    mylist.append(i)&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>


<p>gives as output:</p>
<div class="highlight"><pre><span></span>  1           0 BUILD_LIST               0
              3 STORE_NAME               0 (mylist)

  2           6 SETUP_LOOP              33 (to 42)
              9 LOAD_NAME                1 (range)
             12 LOAD_CONST               0 (1000)
             15 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             18 GET_ITER
        &gt;&gt;   19 FOR_ITER                19 (to 41)
             22 STORE_NAME               2 (i)

  3          25 LOAD_NAME                0 (mylist)
             28 LOAD_ATTR                3 (append)
             31 LOAD_NAME                2 (i)
             34 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             37 POP_TOP
             38 JUMP_ABSOLUTE           19
        &gt;&gt;   41 POP_BLOCK
        &gt;&gt;   42 LOAD_CONST               1 (None)
             45 RETURN_VALUE
</pre></div>


<p>The left-most set of numbers (1, 2, and 3) represent the particular line being
disassembled, while the second set of numbers (0, 3, 6, 9, 12, 15, etc...)
represent the offset that the given opcode is from the start of the bytecode
sequence.</p>
<p>Compare that to disassembling a list comprehension</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dis</span>

<span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;mylist = [i for i in range(1000)]&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>  1           0 LOAD_CONST               0 (&lt;code object &lt;listcomp&gt; at 0x7f4d22d959c0, file &quot;&lt;dis&gt;&quot;, line 1&gt;)
              3 LOAD_CONST               1 (&#39;&lt;listcomp&gt;&#39;)
              6 MAKE_FUNCTION            0
              9 LOAD_NAME                0 (range)
             12 LOAD_CONST               2 (1000)
             15 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             18 GET_ITER
             19 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             22 STORE_NAME               1 (mylist)
             25 LOAD_CONST               3 (None)
             28 RETURN_VALUE
</pre></div>


<p>To me, the significant difference is that the list comprehension doesn't make
calls to <code>append</code>, like the for loop does - that means using a list
comprehension uses less instructions and doesn't have the overhead of an extra
function call on every iteration. Neat!</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://brookskindle.github.io/tag/python.html">python</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Brooks Kindle ",
  "url" : "https://brookskindle.github.io",
  "image": "/images/profile.jpg",
  "description": "None"
}
</script>

</body>
</html>